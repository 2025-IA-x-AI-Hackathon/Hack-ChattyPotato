# ğŸ¥” ChattyPotato

> **AI Hackathon 2025 | Team IA_X**  
> í˜¼í•©í˜• ë¼ìš°íŒ… ê¸°ë°˜ RAG ì‹œìŠ¤í…œ â€” *â€œìµœì ì˜ ëª¨ë¸ì„ ë˜‘ë˜‘í•˜ê²Œ ì„ íƒí•˜ê³ , ë¹ ë¥´ê²Œ ëŒ€ë‹µí•œë‹¤.â€*

---

## ğŸš€ í”„ë¡œì íŠ¸ ê°œìš”

**ChattyPotato**ëŠ” LLM ê¸°ë°˜ Q&A ì‹œìŠ¤í…œì— **í•˜ì´ë¸Œë¦¬ë“œ ë¼ìš°íŒ…(ì €ë¹„ìš© â†” ê³ ì„±ëŠ¥ ëª¨ë¸ ìë™ ë¶„ê¸°)**ì„ ê²°í•©í•œ  
**RAG (Retrieval-Augmented Generation)** íŒŒì´í”„ë¼ì¸ì…ë‹ˆë‹¤.

> â€œì§ˆë¬¸ì„ ì´í•´í•˜ê³ , ë¬¸ë§¥ì„ ì°¾ì•„, ê°€ì¥ ì ì ˆí•œ ëª¨ë¸ë¡œ ëŒ€ë‹µí•œë‹¤.â€

### ğŸ¯ ì£¼ìš” íŠ¹ì§•
- ğŸ§  **Retrieval**: ë‚´ë¶€ + ì›¹ ê¸°ë°˜ ë¬¸ì„œ ê²€ìƒ‰ (Vector + BM25)
- ğŸ§© **Augmentation**: ë¬¸ì„œ ìš”ì•½ ë° ì»¨í…ìŠ¤íŠ¸ ì¡°ë¦½
- âš™ï¸ **Generation**: í”„ë¡¬í”„íŠ¸ êµ¬ì„± + ëª¨ë¸ ì„ íƒ + ì‘ë‹µ ìƒì„±
- ğŸ”€ **Routing**: í´ë¼ì´ì–¸íŠ¸ vs ì„œë²„ ëª¨ë¸ ìë™ ê²°ì •
- ğŸ“Š **Observability**: ElasticSearch ê¸°ë°˜ ì „ ë‹¨ê³„ ë¡œê¹…

---

## ğŸ§± ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ë¶„ | ê¸°ìˆ  |
|------|------|
| **Backend** | Spring Boot 3.x, Java 21 |
| **LLM APIs** | AWS Bedrock (Titan Embeddings, Claude 3, Mistral), OpenAI GPT-4o |
| **Vector Store** | Elasticsearch Vector Index |
| **Observability** | ElasticSearch (Logs + TraceId), Micrometer, OpenTelemetry |
| **Async Handling** | CompletableFuture, Custom Executor |
| **Build/Deploy** | Gradle, Docker, AWS ECS Fargate |

---

## ğŸ§­ ì „ì²´ ë°ì´í„° í”Œë¡œìš°

![Alt text](image.png)

---

# Java_langchainLike ì„¤ê³„ ë° ì±…ì„ ë²”ìœ„

## âš™ï¸ 1ï¸âƒ£ RetrieveChain

**ì—­í• :** ì§ˆì˜ ì¬ì‘ì„± â†’ ì„ë² ë”© â†’ ë¬¸ì„œ ê²€ìƒ‰ (ë‚´ë¶€ + ì›¹)

**í•µì‹¬ í‚¤ì›Œë“œ:** *Query Understanding & Knowledge Retrieval*

### ğŸ“Œ ì±…ì„

| ë²”ì£¼ | ì„¤ëª… |
| --- | --- |
| ğŸ”¤ **ì…ë ¥ ì •ê·œí™” / ì¬ì‘ì„±** | ì‚¬ìš©ìì˜ ì›ë¬¸ queryë¥¼ ì˜ë¯¸ì ìœ¼ë¡œ í’ë¶€í•˜ê²Œ ë°”ê¾¸ê¸° ìœ„í•´ LLM(cheap model)ì„ ì‚¬ìš©í•¨.<br/>ì˜ˆ: â€œì œì£¼ ìˆ™ì†Œ ì¶”ì²œâ€ â†’ â€œì œì£¼ 2ë°•3ì¼ ì €ì˜ˆì‚° ìˆ™ì†Œ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ ìµœì‹  ì •ë³´â€ |
| ğŸ§  **ì„ë² ë”©(Embedding)** | ì¬ì‘ì„±ëœ ì§ˆì˜ë¥¼ ë²¡í„°ë¡œ ë³€í™˜í•˜ì—¬ ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ì„ ìˆ˜í–‰í•¨. |
| ğŸ“š **ì§€ì‹ ê²€ìƒ‰(Retrieval)** | **VectorStoreRetriever**: ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ ë‚´ë¶€ ë¬¸ì„œ ê²€ìƒ‰ |
| âš–ï¸ **ê²°ê³¼ ë³‘í•©(ScoreMerger)** | ì„¸ ê°€ì§€ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ í†µí•© í›„ í›„ë³´(candidates[]) ìƒì„±. |

---

## ğŸ§© 2ï¸âƒ£ AugmentChain

**ì—­í• :** ê²€ìƒ‰ ê²°ê³¼ë¥¼ LLMì´ ì´í•´í•  ìˆ˜ ìˆëŠ” ì»¨í…ìŠ¤íŠ¸ ë¸”ë¡ìœ¼ë¡œ ì¬êµ¬ì„±

**í•µì‹¬ í‚¤ì›Œë“œ:** *Context Assembly & Citation Generation*

### ğŸ“Œ ì±…ì„

| ë²”ì£¼ | ì„¤ëª… |
| --- | --- |
| âœ‚ï¸ **ë¬¸ì„œ ìš”ì•½ / ìŠ¤ë‹ˆí« ì¶”ì¶œ** | ê° candidateì—ì„œ í•µì‹¬ ë¬¸ì¥ë§Œ ë½‘ì•„ë‚´ê³ , ê³¼ë„í•œ í…ìŠ¤íŠ¸ëŠ” ì œê±°í•¨. |
| ğŸ§± **ì»¨í…ìŠ¤íŠ¸ ë¸”ë¡ êµ¬ì„±(Context)** | ì—¬ëŸ¬ ì¸ìš©ë¬¸ì„ ë¬¶ì–´ì„œ LLMì— ì „ë‹¬í•  **í•˜ë‚˜ì˜ contextText** ë¬¸ìì—´ ìƒì„±. |

---

## ğŸ¤– 3ï¸âƒ£ GenerateChain

**ì—­í• :** ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ë‹µë³€ ìƒì„± + ëª¨ë¸ ì„ íƒ + ë¹„ìš©/ì‹œê°„ ì¸¡ì •

**í•µì‹¬ í‚¤ì›Œë“œ:** *LLM Reasoning & Routing Decision*

### ğŸ“Œ ì±…ì„

| ë²”ì£¼ | ì„¤ëª… |
| --- | --- |
| ğŸ§¾ **í”„ë¡¬í”„íŠ¸ ì¡°ë¦½** | ì‚¬ìš©ì ì§ˆì˜ + contextText + citations(ì˜ˆì •)ë¥¼ ì¢…í•©í•˜ì—¬ ë‹µë³€ìš© Prompt êµ¬ì„±. |
| ğŸ§  **LLM ìƒì„±(Answer Generation)** | ì„ íƒëœ ëª¨ë¸ë¡œ ë‹µë³€ì„ ìƒì„±í•˜ê³ , JSON í˜•ì‹(ë‹µë³€, ì¸ìš©, ë©”íƒ€ë°ì´í„°)ìœ¼ë¡œ íŒŒì‹±. |
| â±ï¸ **ì„±ëŠ¥/ë¹„ìš© ì¸¡ì •** | latency, token usage, cost ê³„ì‚° í›„ ì‘ë‹µ DTOì— í¬í•¨. |

---

ë¦¬íŠ¸ë¦¬ë²Œ ì²´ì¸ â†’ í˜„ì¬ ì¿¼ë¦¬ ë¦¬ë¼ì´íŒ… â†’ ì„ë² ë”© ê²€ìƒ‰ â†’ (vector & webê²€ìƒ‰)ë¬¸ì„œë“¤ + ë¦¬ë¼ì´íŒ…ëœ ì¿¼ë¦¬ ë°˜í™˜(DTO)

ì•„êµ¬ë¨¼íŠ¸ ì²´ì¸ â†’ ë¬¸ì„œ + ì¿¼ë¦¬ â†’ í•˜ë‚˜ì˜ ì§ˆë¬¸ (ë¬¸ë§¥ ì„¹í„° + ì§ˆë¬¸ì„¹í„°) â†’ ë¬¸ë§¥ ì„¹í„° ì œí•œì— ë§ê²Œ ë¬¸ì„œ ìš”ì•½ (LLM)
â†’ ì¿¼ë¦¬ ì„¹í„°ì— ë§ê²Œ ì¿¼ë¦¬ ìš”ì•½(LLM) â†’ ë¬¸ë§¥ ì„¹í„° + ì§ˆë¬¸ ì„¹í„° ì»¨í…ìŠ¤íŠ¸ ë¸”ëŸ­(DTO)

ì œë„ˆë ˆì´íŠ¸ ì²´ì¸ â†’ ê°€ê³µí•œ ëŒ€í™” ë¬¸ë§¥ ìƒì„± â†’ llmì— ë³´ë‚´ê¸° â†’ ë°›ì€ ë‹µë³€ ì €ì¥(DTO)

---

## í† í° ì œí•œ ì²˜ë¦¬ ê³¼ì •

| ë‹¨ê³„ | ì²˜ë¦¬ ë°©ì‹ | ì„¤ëª… |
| --- | --- | --- |
| Retriever | ìƒìœ„ Nê°œ ë¬¸ì„œ ì œí•œ (`limit(10)`) | ë¹ ë¥¸ ì»· |
| AugmentedChain | `TokenCounter`ë¡œ í† í° ëˆ„ì  ì œí•œ | ì•ˆì „ ì»· |
| PromptAssembler | ì „ì²´ prompt í† í° ê²€ì¦ | ìµœì¢… ì»· |

## ìµœì¢… í”„ë¡¬í”„íŠ¸ í† í° ìˆ˜

| ì„¹ì…˜ | ëª©ì  | í† í° ìˆ˜ (ê¶Œì¥) | ë¹„ìœ¨ | ê·¼ê±° |
| --- | --- | --- | --- | --- |
| ğŸŸ© **System Prompt** | ëª¨ë¸ ì—­í•  ì •ì˜ (â€œë„ˆëŠ” ì—¬í–‰ íë ˆì´í„°ì•¼...â€) | **150â€“250** | 10% | ì§§ì§€ë§Œ í†¤/ì—­í•  ê²°ì •. ì‘ë‹µ ì¼ê´€ì„± í™•ë³´ìš©. |
| ğŸŸ¦ **Rewrite Query** | ê²€ìƒ‰ ë° ë¼ìš°í„° ì…ë ¥ìš© í•µì‹¬ ë¬¸ì¥ | **â‰¤100** | 5% | BERT/BART ì ìˆ˜ ë¹„êµì˜ ê¸°ì¤€. ì§§ì„ìˆ˜ë¡ ë¼ìš°íŒ… ì •í™•ë„ â†‘ |
| ğŸŸª **Original Query (Reinjection)** | ì›ë¬¸ì˜ ë‰˜ì•™ìŠ¤Â·ì˜ë„ ë³µì› | **300â€“500 (ìµœëŒ€ 512)** | 20â€“25% | ê¸´ ì§ˆë¬¸ë„ nuance ìœ ì§€. ë‹¨, 500 ë„˜ìœ¼ë©´ LLM context ì••ë°•. |
| ğŸŸ¨ **Retrieved Context (Docs)** | ê²€ìƒ‰ëœ ë¬¸ì„œ ìš”ì•½/ê·¼ê±° ì œê³µ | **900â€“1200** | 45â€“50% | ë¬¸ì„œë‹¹ 512tokens ìš”ì•½ Ã— 2~3ê°œ. ì •ë³´ ë°€ë„ ìœ ì§€. |
| ğŸŸ¥ **Instruction / Output Format** | JSON ì‘ë‹µ ì§€ì‹œ or ìŠ¤íƒ€ì¼ ì§€ì • | **150â€“250** | 10% | ëª¨ë¸ ì¶œë ¥ì„ êµ¬ì¡°í™”í•˜ê¸° ìœ„í•œ ëª…ì‹œ. |
| âšª **ì´í•© (ì…ë ¥)** |  | **1800â€“2200 tokens** | 100% | 8k ëª¨ë¸ ëŒ€ë¹„ 25â€“30% ì‚¬ìš© â†’ ì•ˆì • + ë¹ ë¦„ |

## LLM Router

### Background

LLM ë¹„ìš©ì´ ë†’ì•„ì§ì— ë”°ë¼, ì‚¬ìš© ì‚¬ë¡€ì— ë”°ë¼ ì ì ˆí•œ ëª¨ë¸ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´ì¡ŒìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ê°„ë‹¨í•œ ì§ˆë¬¸ì—ëŠ” ì €ë ´í•œ ëª¨ë¸ì„ ì‚¬ìš©í•˜ê³ , ë³µì¡í•œ ì‘ì—…ì—ëŠ” ê³ ì„±ëŠ¥ ëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¹„ìš© íš¨ìœ¨ì„±ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ì‰¬ìš´ ì¿¼ë¦¬ë€ ë¬´ì—‡ì¼ê¹Œ?

- ì‰¬ìš´ ì¿¼ë¦¬ëŠ” ì ì€ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§„ LLMì˜ ì‘ë‹µí’ˆì§ˆê³¼ ë§ì€ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§„ LLMì˜ ì‘ë‹µ í’ˆì§ˆì— ì°¨ì´ê°€ ì ê±°ë‚˜, ìœ ì‚¬í•œ ì¿¼ë¦¬ë“¤ì„ ë§í•©ë‹ˆë‹¤. ì´ëŠ” ì§ˆë¬¸ì— ëŒ€í•œ ê¸¸ì´ì— ì˜í•´ ê²°ì • ë˜ì§€ ì•Šê³ , ì‘ë‹µ ê²°ê³¼ë¥¼ ê³ ë ¤í•´ ê²°ì •í•©ë‹ˆë‹¤.
- ì¦‰, LOW Cost LLMì„ ì´ìš©í•´ ì ì€ ë¹„ìš©ìœ¼ë¡œë„ ë¹„ì‹¼ LLMê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ” ê²½ìš° Low Cost Modelì„ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤ë©´ ì‘ë‹µ í’ˆì§ˆì˜ ì €í•˜ ì—†ì´ ë¹„ìš©ì„ ì•„ë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

### ë°ì´í„° ì…‹
- ì‚¬ìš©ìì˜ ì…ë ¥(ì¿¼ë¦¬)
- í‘œì¤€ ì‘ë‹µ
- Low costì˜ ì‘ë‹µ
- High costì˜ ì‘ë‹µ
### ì‰¬ìš´ ì¿¼ë¦¬ íŒë³„ ë°©ë²•
- í‘œì¤€ì‘ë‹µê³¼ Low costì˜ ì‘ë‹µê³¼ High costì˜ ì‘ë‹µì„ low cost, high cost LLMì˜ ì‘ë‹µê³¼ ë¹„êµí•©ì—¬ ê°ê°ì˜ ì‘ë‹µí’ˆì§ˆì„ ìˆ˜ì¹˜í™”í•©ë‹ˆë‹¤.
- ì´ë¥¼ ìœ„í•´, BARTScoreë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. BartScoreëŠ” í‘œì¤€ì‘ë‹µê³¼ ê°€ê¹Œìš¸ ìˆ˜ë¡ 0ì— ê°€ê¹Œìš´ ê°’ì„ ë°›ìŠµë‹ˆë‹¤. ê°ê°ì˜ ì‘ë‹µ í’ˆì§ˆì„ í†µí•´, ë‹¤ìŒê³¼ ê°™ì€ ê¸°ì¤€ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

$$H(x) = Q(S(X)-L(X))$$

- H(x) >= 0 : Low Cost LLMì˜ ì‘ë‹µ í’ˆì§ˆì´ High Cost LLMì˜ ì‘ë‹µ í’ˆì§ˆë³´ë‹¤ ë†’ë‹¤ëŠ” ì˜ë¯¸
- H(x) < 0 : High Cost LLMì˜ ì‘ë‹µ í’ˆì§ˆì´ Low Cost LLMì˜ ì‘ë‹µ í’ˆì§ˆë³´ë‹¤ ë†’ë‹¤ëŠ” ì˜ë¯¸

ì¦‰, ìš°ë¦¬ëŠ” H(x)ê°€ 0 ì´ìƒì¸ ê²½ìš°ë¥¼ ì‰¬ìš´ ì¿¼ë¦¬ë¡œ ì •ì˜í•˜ê³ , Router ëª¨ë¸ì—ê²Œ ì‰¬ìš´ ì¿¼ë¦¬ë¥¼ íŒë³„í•˜ë„ë¡ í•™ìŠµì‹œí‚µë‹ˆë‹¤.

## í•™ìŠµ

- ì¿¼ë¦¬ Xë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ì•„, H(x)ë¥¼ ì¶œë ¥í•˜ëŠ” ëª¨ë¸ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.
- H(x) >= 0 ì¸ ê²½ìš° ì‰¬ìš´ ì¿¼ë¦¬ë¡œ, H(x) < 0 ì¸ ê²½ìš° ì–´ë ¤ìš´ ì¿¼ë¦¬ë¡œ ë¼ë²¨ë§í•©ë‹ˆë‹¤.
- ëª¨ë¸ì€ ì¿¼ë¦¬ Xë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ì•„, ì‰¬ìš´ ì¿¼ë¦¬ì¸ì§€ ì–´ë ¤ìš´ ì¿¼ë¦¬ì¸ì§€ ë¶„ë¥˜í•˜ëŠ” ì´ì§„ ë¶„ë¥˜ ëª¨ë¸ë¡œ í•™ìŠµë©ë‹ˆë‹¤.
- ëª¨ë¸ ì•„í‚¤í…ì²˜ë¡œëŠ” facebook/base-v3-base ëª¨ë¸ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. 

## ê²°ê³¼
- ë°ì´í„°ì…‹ í™•ë³´ì— ì‹œê°„ì„ ì¶©ë¶„íˆ ì–»ì§€ ëª»í•´ ì¶©ë¶„í•œ ì„±ëŠ¥ì„ ì–»ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.


















